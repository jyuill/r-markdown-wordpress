---
title: "Dual-Axis Charts: Alternatives"
author: "`r Sys.getenv('USER')`"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message=FALSE,
                      warning=FALSE,
                      fig.height=6,
                      fig.width=9)
options(scipen = 99)
options(digits=3)

library(knitr) ## for functions like include_graphics
library(gtrendsR)
library(tidyverse)
library(lubridate)
library(scales)
library(gridExtra)
library(cowplot)
library(here)
library(quantmod)
library(PerformanceAnalytics)
library(kableExtra)

theme_set(theme_minimal())
```

## Alternatives to Dual-Axis Charts

In a previous blog post, I went through temptations and traps of **dual-axis** charts. These are charts where you want to compare two metrics or data attributes but there are vastly different scales involved, so you reach for a layout with two y-axes in order to deal with the scales separately. I acknowledged this is a tempting choice, but fraught with danger due to at least a couple of common issues:

1. **Misrepresentation due to mixed scales**: changing relative scales arbitrarily can suggest different conclusions and imply relationships that may not be as strong (or weak) as they appear.
2. **Difficultly in interpretation**: these charts require extra mental effort to untangle the lines and associate them with their respective data points.

I also provided some basic tips on how to avoid/minimize these issues with dual-axis charts so here I want to try out some alternatives that may provide even better options for communicating effectively with data.

As noted in the previous post, there are two common scenarios where dual-axis charts come up and we will walk through alternatives for each of them.

1. Comparing trends in two (or more) similar data sets that have vastly different scales.
2. Comparing a volume metric with a related rate or ratio metric. (so, again, vastly different scales)

As usual, the examples here are produced using R, with ggplot2 package as the preferred visualization tool.

```{r}
## import crypto data
crypto_data <- read_csv(here('dual-axis','input','btc-ada-price.csv'))
```

## Scenario 1: Compare trends in similar metrics from two datasets

Same example as previous post: prices history of two different crypotcurrencies - Cardano, with its token ADA and Bitcoin (BTC). 

As always, the visualization choice should be based on **what questions we are trying to answer** and **what we are hoping to learn**. The visualization should then be judged against effectiveness in shedding light on these questions.

So we may have questions like:

* What are the relative changes in the currencies over time?
* Do the two follow a similar pattern of ups and downs?
* Are there any points where a general pattern breaks? (could provide focus for further investigation)

In this random sample of recent data (Cdn$), we can see the two sets of prices are on much different scales!

```{r}
## get random sample of row numbers
smpl <- sample(1:nrow(crypto_data), 6, replace = FALSE)
## generate table of random rows, by date; 'float_left' allows tables to be side-by-side
crypto_data[smpl,] %>% arrange(date) %>% kable %>% kable_styling(full_width = FALSE, position='float_left')
## show summary of data
summary(crypto_data) %>% kable %>% kable_styling(full_width = FALSE, position='left')
```

### Line charts stacked vertically

```{r crypto-plot-01, echo=TRUE, fig.height=4, fig.width=6}
cp01 <- crypto_data %>% ggplot(aes(x=date, y=BTC_CAD))+geom_line()+
  scale_y_continuous(labels=dollar_format())+
  labs(title='BTC (top) and ADA (bottom) prices (CDN$)', x='')+
  theme(axis.text.x = element_blank())
cp02 <- crypto_data %>% ggplot(aes(x=date, y=ADA_CAD))+geom_line()+
  scale_y_continuous(labels=dollar_format())+
  labs(x='')
#grid.arrange(cp01, cp02, nrow=2)
plot_grid(cp01, cp02, nrow=2, align='v')
```

* still scale comparison issues but at least more interpretable
* add correlation here?

```{r}
cor.test(crypto_data$BTC_CAD, crypto_data$ADA_CAD)
```

```{r}
crypto_data %>% ggplot(aes(x=BTC_CAD, y=ADA_CAD))+geom_point()+
  geom_smooth(method='lm')
```



### % chg

```{r}
crypto_data_pc <- crypto_data %>% mutate(BTC_CAD_pc=BTC_CAD/lag(BTC_CAD)-1,
                                         ADA_CAD_pc=ADA_CAD/lag(ADA_CAD)-1)
crypto_data_pc %>% ggplot(aes(x=date, y=BTC_CAD_pc))+geom_line(color='goldenrod')+
  scale_y_continuous(labels=percent_format())+
  geom_line(aes(y=ADA_CAD_pc), color='blue')
```

* shorten period for readability
* calc change over longer periods (WoW rather than DoD)
* try bars?


```{r}
crypto_data_pc_lg <- crypto_data_pc %>% select(date, BTC_CAD_pc, ADA_CAD_pc) %>% 
  pivot_longer(cols=c(BTC_CAD_pc, ADA_CAD_pc), names_to='currency', values_to = 'pc_chg') 
crypto_data_pc_lg %>% ggplot(aes(x=date, y=pc_chg, fill=currency))+geom_col(position = position_dodge2())
```

* need either selected or aggregated time periods (time series)

### Statistical methods of comparison

correlation / linear regression on price
distribution of price chg

```{r}
crypto_data_pc_lg %>% ggplot(aes(x=currency, y=pc_chg))+geom_boxplot(color='blue')
```


## Notes: alternatives to Dual-Axis

* separate -> either side-by-side or above/below; especially if the focus is more on one than the other
* % chg
* normalize each dataset (center on zero)
* volume and ratio: vol in bars smaller underneath (stock market style)
* use along with other statistical measures

tips:

* make sure carefully labelled
* in some cases, label lines directly
* consider mixing bars (vol) and lines (ratios)
* be responsible - don't contort to fit your pre-defined message or beliefs or hopes
* make second axis a factor of 10 ratio
* use bars with lines on ratio charts
* combine with other statistics:
  + correlation
  + standard deviation (how to deal with non-normal? )